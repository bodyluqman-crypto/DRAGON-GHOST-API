import socket
import threading
import time
import json
import jwt
from datetime import datetime
from utils import CryptoUtils, ProtobufUtils, logger
from config import Config

class GhostAccount:
    def __init__(self, account_id, password):
        self.account_id = account_id
        self.password = password
        self.key = None
        self.iv = None
        self.socket_client = None
        self.is_connected = False
        self.last_activity = datetime.now()
        self.connection_attempts = 0
        
    def connect(self):
        """Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù… Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ±Ø¯ÙŠ"""
        try:
            logger.info(f"ğŸ”„ Ø¬Ø§Ø±ÙŠ ØªÙˆØµÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ {self.account_id}...")
            
            # Ù…Ø­Ø§ÙƒØ§Ø© Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
            token_data = self.get_auth_token()
            if token_data:
                self.key, self.iv = token_data
            
            # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„ÙŠÙ‡Ø§
            if not self.key:
                self.key = Config.AES_KEY
                self.iv = Config.AES_IV
            
            self.is_connected = True
            self.last_activity = datetime.now()
            logger.info(f"âœ… ØªÙ… ØªÙˆØµÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ {self.account_id} Ø¨Ù†Ø¬Ø§Ø­")
            return True
            
        except Exception as e:
            logger.error(f"âŒ ÙØ´Ù„ ØªÙˆØµÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ {self.account_id}: {e}")
            return False
    
    def get_auth_token(self):
        """Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙˆÙƒÙ† Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©"""
        try:
            # Ù‡Ù†Ø§ Ø¨ØªÙƒÙˆÙ† Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ø§Ù„ÙØ¹Ù„ÙŠØ© Ù…Ø¹ Ø³ÙŠØ±ÙØ± Free Fire
            # Ø­Ø§Ù„ÙŠØ§Ù‹ Ø¨Ù†Ø±Ø¬Ø¹ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
            return Config.AES_KEY, Config.AES_IV
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©: {e}")
            return None
    
    def send_single_ghost(self, team_code, ghost_name):
        """Ø¥Ø±Ø³Ø§Ù„ Ø´Ø¨Ø­ ÙˆØ§Ø­Ø¯ Ù„Ù„ÙØ±ÙŠÙ‚"""
        try:
            if not self.is_connected:
                if not self.connect():
                    return False, "ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„"
            
            logger.info(f"ğŸ‘» Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø´Ø¨Ø­ {ghost_name} Ù„Ù„ÙØ±ÙŠÙ‚ {team_code}...")
            
            # Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø²Ù…Ø© Ø§Ù„Ø´Ø¨Ø­
            ghost_packet = self.create_ghost_packet(team_code, ghost_name)
            
            # Ù…Ø­Ø§ÙƒØ§Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø­Ø²Ù…Ø©
            success = self.simulate_send_packet(ghost_packet)
            
            if success:
                self.last_activity = datetime.now()
                logger.info(f"âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø´Ø¨Ø­ {ghost_name} Ù„Ù„ÙØ±ÙŠÙ‚ {team_code} Ø¨Ù†Ø¬Ø§Ø­")
                return True, f"ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø´Ø¨Ø­ {ghost_name} Ù„Ù„ÙØ±ÙŠÙ‚ {team_code}"
            else:
                return False, "ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø´Ø¨Ø­"
            
        except Exception as e:
            logger.error(f"âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø´Ø¨Ø­ Ù…Ù† {self.account_id}: {e}")
            self.is_connected = False
            return False, f"Ø®Ø·Ø£: {str(e)}"
    
    def simulate_send_packet(self, packet_data):
        """Ù…Ø­Ø§ÙƒØ§Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø­Ø²Ù…Ø© - ÙÙŠ Ø§Ù„ÙˆØ§Ù‚Ø¹ ØªØ±Ø³Ù„ Ø¹Ø¨Ø± socket"""
        try:
            # Ù…Ø­Ø§ÙƒØ§Ø© Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
            logger.info(f"ğŸ“¦ Ù…Ø­Ø§ÙƒØ§Ø© Ø¥Ø±Ø³Ø§Ù„ Ø­Ø²Ù…Ø© Ø´Ø¨Ø­: {packet_data[:50]}...")
            
            # Ù‡Ù†Ø§ Ø¨ØªÙƒÙˆÙ† Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ¹Ù„ÙŠØ©
            # time.sleep(0.5)  # Ù…Ø­Ø§ÙƒØ§Ø© ÙˆÙ‚Øª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
            
            return True
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: {e}")
            return False
    
    def create_ghost_packet(self, team_code, ghost_name):
        """Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø²Ù…Ø© Ø§Ù„Ø´Ø¨Ø­"""
        try:
            fields = {
                1: 61,  # Ù†ÙˆØ¹ Ø§Ù„Ø­Ø²Ù…Ø© - Ø´Ø¨Ø­
                2: {
                    1: int(team_code),  # ÙƒÙˆØ¯ Ø§Ù„ÙØ±ÙŠÙ‚
                    2: {
                        1: int(team_code),
                        2: 1159,  # Ù†ÙˆØ¹ Ø§Ù„Ø´Ø¨Ø­
                        3: f"[c]{ghost_name}",  # Ø§Ø³Ù… Ø§Ù„Ø´Ø¨Ø­
                        5: 12,    # Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø´Ø¨Ø­
                        6: 15,    # Ù‚ÙˆØ© Ø§Ù„Ø´Ø¨Ø­
                        7: 1,     # Ù†Ø´Ø·
                        8: {2: 1, 3: 1},  # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
                        9: 3,     # Ù†ÙˆØ¹ Ø§Ù„Ù‡Ø¬ÙˆÙ…
                    },
                    3: "ghost_auth_code",  # ÙƒÙˆØ¯ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
                }
            }
            
            packet = ProtobufUtils.create_packet(fields)
            hex_packet = packet.hex()
            
            logger.info(f"ğŸ”§ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø²Ù…Ø© Ø´Ø¨Ø­ Ù„Ù„ÙØ±ÙŠÙ‚ {team_code}")
            return hex_packet
            
        except Exception as e:
            logger.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø²Ù…Ø© Ø§Ù„Ø´Ø¨Ø­: {e}")
            raise e
    
    def disconnect(self):
        """Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„"""
        try:
            self.is_connected = False
            logger.info(f"ğŸ“´ ØªÙ… Ù‚Ø·Ø¹ Ø§ØªØµØ§Ù„ Ø§Ù„Ø­Ø³Ø§Ø¨ {self.account_id}")
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ù‚Ø·Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„: {e}")

class SingleAccountPool:
    """Ù…Ø¬Ù…ÙˆØ¹Ø© Ø­Ø³Ø§Ø¨ ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·"""
    def __init__(self):
        self.accounts = {}
        self.lock = threading.Lock()
        self.load_single_account()
    
    def load_single_account(self):
        """ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ±Ø¯ÙŠ"""
        accounts_data = AccountManager.load_accounts()
        with self.lock:
            # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙÙ‚Ø·
            if Config.MAIN_ACCOUNT_ID in accounts_data:
                acc_id = Config.MAIN_ACCOUNT_ID
                password = accounts_data[acc_id]
                self.accounts[acc_id] = GhostAccount(acc_id, password)
                logger.info(f"ğŸ‘¤ ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ±Ø¯ÙŠ: {acc_id}")
            else:
                logger.error("âŒ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù…Ù„Ù")
    
    def get_main_account(self):
        """Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ"""
        with self.lock:
            if Config.MAIN_ACCOUNT_ID in self.accounts:
                return self.accounts[Config.MAIN_ACCOUNT_ID]
            return None
    
    def send_single_ghost_attack(self, team_code, ghost_name):
        """Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø¬ÙˆÙ… Ø´Ø¨Ø­ ÙØ±Ø¯ÙŠ"""
        account = self.get_main_account()
        if not account:
            return False, "Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ØºÙŠØ± Ù…ØªÙˆÙØ±"
        
        # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø´Ø¨Ø­
        success, message = account.send_single_ghost(team_code, ghost_name)
        
        return success, message
    
    def cleanup(self):
        """ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯"""
        with self.lock:
            for account in self.accounts.values():
                account.disconnect()
